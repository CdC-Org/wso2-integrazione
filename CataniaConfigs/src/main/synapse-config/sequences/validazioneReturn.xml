<?xml version="1.0" encoding="UTF-8"?>
<sequence name="validazioneReturn" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="full"/>
    <script language="js"><![CDATA[var plInput = mc.getPayloadJSON();      
    		
    	
		var log = mc.getServiceLog();
		

        log.info(">>plInput: " +  JSON.stringify(plInput)); 
        
        var esito = plInput.payload.esito;
        var status = "false";
        log.info(">>esito: " + esito);
        
        var outcome = plInput.outcome;
        log.info(">>outcome: " +  JSON.stringify(outcome));
        var issue = outcome.issue;
        log.info(">>issue: " +  JSON.stringify(issue));
        log.info(">>issue.length: " +  issue.length);
        
      	var   stringaWarnings = '';

                     
        if (esito == '0')
        {
        	
        	status = "true";
        	stringaWarnings = ' ';
        	
        }
        
        
        var nIterazioni = -1;
        log.info(">>nIterazioni: " + nIterazioni);
        
		if (esito == '1')
        {
        	
        	status = "false";
			
			for (i = 0; i < issue.length; ++i)
			{
				log.info(">>issue.message: " +  issue[i].message);
				log.info(">>issue.code: " +  issue[i].code);
				
				if (issue[i].code == 'IBLV-1' || issue[i].code == 'IBLV-4' || issue[i].code == 'IBLV-5'  || issue[i].code == 'IBLV-7' )
				{
					if (nIterazioni <0 )
					{	
						if (issue[i].code != 'IBLV-7')
						{
							stringaWarnings = issue[i].details + ": " + issue[i].message;
							nIterazioni ++;
							status = "false";
						}
						else 
						{
							if (issue[i].code == 'IBLV-7' && issue[i].message != "Controllo non effettuabile" )
							{
								stringaWarnings = issue[i].message;
								nIterazioni ++;
								status = "false";
							}
						}
					}
					else
					{
						if (issue[i].code != 'IBLV-7')
						{							
							stringaWarnings = stringaWarnings + "; " + issue[i].details + ": " + issue[i].message;
							nIterazioni ++;
							status = "false";						
						}
						else
						{
							if (issue[i].code == 'IBLV-7' && issue[i].message != "Controllo non effettuabile" )
							{
								stringaWarnings = issue[i].message;
								nIterazioni ++;
								status = "false";
							}
						}
					}
					
					log.info(">>nIterazioni: " + nIterazioni);
				}	
				
			}
			if (nIterazioni <0 )
			{
				status = "true";
				stringaWarnings = ' ';
			}

        }
       		

        log.info(">>warnings: " +  stringaWarnings);
        
        var response = {"status": 	status, 
        				"message": 	stringaWarnings};


		
        mc.setPayloadJSON(response);]]></script>
    <respond/>
</sequence>
