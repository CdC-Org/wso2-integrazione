<?xml version="1.0" encoding="UTF-8"?>
<sequence name="iscrizioneValidazioneResponse" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <script language="js"><![CDATA[var plInput = mc.getPayloadJSON();      
		var log = mc.getServiceLog();
        var esito = plInput.payload.esito;
        var status = "false";
        var outcome = plInput.outcome;
      	var stringaWarnings = '';

        if (esito == '0' && (plInput.outcome == null || plInput.outcome.issue == null || plInput.outcome.issue.length == 0)) {
        	status = "true";
        	stringaWarnings = ' ';
        } else {
        	status = "false";
	        var issue = plInput.outcome.issue;
			
			for (i = 0; i < issue.length; ++i) {
				var code = issue[i].code;
				var message = issue[i].message;
				if (code == 'IIMV-1' || code == 'IIMV-2' || code == 'IIMV-3' || code == 'IIMV-4' || code == 'IIMV-5') {
					switch (code) {
               		case 'IIMV-1':
                		if(message.indexOf("Controllo non effettuabile") != -1) {
   	            			stringaWarnings = stringaWarnings + "['data_nascita', 'controllo non effettuabile', '']";
       	        		} else {
           	    			stringaWarnings = stringaWarnings + "['data_nascita', 'controllo ko', 'La data di nascita del figlio non è una data valida']";
               			}
   						break;
   					case 'IIMV-2':
                		if(message.indexOf("Controllo non effettuabile") != -1) {
   	            			stringaWarnings = stringaWarnings + "['cf_figlio', 'controllo non effettuabile', '']";
       	        		} else if(message == 'Valore non presente' || message == 'Codice Fiscale non valido' || message == 'Giorno di nascita non valido') {
           	    			stringaWarnings = stringaWarnings + "['cf_figlio', 'controllo ko', 'Il codice fiscale del minore non è formalmente corretto']";
               			} else if(message == 'Sesso non compatibile') {
           	    			stringaWarnings = stringaWarnings + "['cf_figlio', 'controllo ko', 'Il codice fiscale del minore non è coerente con il sesso']";
               			} else {
               				stringaWarnings = stringaWarnings + "['cf_figlio', 'controllo ko', 'Il codice fiscale del minore non è coerente con la data di nascita']";
               			}
   						break;
  					case 'IIMV-3':
                		if(message.indexOf("Controllo non effettuabile") != -1) {
   	            			stringaWarnings = stringaWarnings + "['nazionalita', 'controllo non effettuabile', '']";
       	        		} else if(issue[i].message == 'La Nazione deve essere indicata in caso di cittadinanza non italiana') {
       	        			stringaWarnings = stringaWarnings + "['nazionalita', 'controllo ko', 'La Nazionalità deve essere indicata in caso di cittadinanza non italiana']";
       	        		}
   						break;
  					case 'IIMV-4':
               			stringaWarnings = stringaWarnings + "['disabilita', 'controllo ko', message]";
   						break;
   					case 'IIMV-5':
               			stringaWarnings = stringaWarnings + "['disabilita', 'controllo ko', message]";
   						break;	
					}
				}
			}
        }
        
        var response = {"status": 	status, 
        				"message": 	stringaWarnings};
		
        mc.setPayloadJSON(response);]]></script>
    <respond/>
</sequence>
